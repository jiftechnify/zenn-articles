---
title: "Go: HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®Content-Lengthã‚’æ­£ã—ãã‚»ãƒƒãƒˆã™ã‚‹æ–¹æ³•"
emoji: "ğŸ“"
type: "tech"
topics: ["go", "http"]
published: true
---

# çµè«–

- ãã‚‚ãã‚‚ã€ã»ã¨ã‚“ã©ã®å ´åˆã¯ã‚ˆã—ãªã«ã‚„ã£ã¦ãã‚Œã‚‹ã®ã§ã€`Content-Length`ã‚’è‡ªåˆ†ã§ã‚»ãƒƒãƒˆã—ãªã‘ã‚Œã°ãªã‚‰ãªã„å ´é¢ã¯éå¸¸ã«ã¾ã‚Œ
    - `body`ã®é•·ã•ãŒã€Œè‡ªæ˜ã€ã§ã‚ã‚Œã°ã€ãã®é•·ã•ãŒè‡ªå‹•çš„ã«ã‚»ãƒƒãƒˆã•ã‚Œã‚‹ 
    - ãã†ã§ãªã‘ã‚Œã°ã€è‡ªå‹•çš„ã«`Transfer-Encoding: chunked`ã§é€ä¿¡ã•ã‚Œã‚‹
- `Content-Length`ã‚’è‡ªåˆ†ã§ã‚»ãƒƒãƒˆã™ã‚‹ã«ã¯ã€**`http.Request`ã®`ContentLength`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**ã«å€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹ã®ãŒæ­£è§£

```go
// âœ…
var size int64 = ...
req.ContentLength = size
```

- `Header`ã«ç›´æ¥`Content-Length`ã‚’ã‚»ãƒƒãƒˆã—ã¦ã‚‚**ç„¡è¦–ã•ã‚Œã‚‹**

```go
// âŒ
var size int64 = ...
req.Header.Set("Content-Length", strconv.FormatInt(size, 10))
```

# ã»ã¨ã‚“ã©ã®å ´åˆã¯è‡ªåˆ†ã§ã‚»ãƒƒãƒˆã—ãªãã¦ã„ã„

Goã§HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†å‡¦ç†ã‚’æ›¸ãéš›ã«ã€`Content-Length`ã®ã“ã¨ã‚’æ°—ã«ã™ã‚‹å¿…è¦ã¯ã»ã¼ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã€æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®`http`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã€Œã„ã„æ„Ÿã˜ã€ã«ã‚„ã£ã¦ãã‚Œã¦ã„ã‚‹ãŠã‹ã’ã§ã™ã€‚

`http.Request`ã®`ContentLength`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ˜ç¤ºçš„ã«ã‚»ãƒƒãƒˆã—ãªã‹ã£ãŸå ´åˆã€`body`ã®æ€§è³ªã«å¿œã˜ã¦ä»¥ä¸‹ã®ã©ã¡ã‚‰ã‹ã®å‹•ä½œã‚’ã—ã¾ã™ã€‚

## `body`ã®é•·ã•ãŒã€Œè‡ªæ˜ã€ãªå ´åˆ

å…·ä½“çš„ã«ã„ã†ã¨ã€`body`ã®å…·ä½“çš„ãªå‹ãŒ 

- `*bytes.Buffer`
- `*bytes.Reader`
- `*strings.Reader`

ã®ã†ã¡ã®ã„ãšã‚Œã‹ã®å ´åˆã§ã™ã€‚ã“ã‚Œã‚‰ã®å‹ã®å€¤ã¯é•·ã•ã®æƒ…å ±ã‚’æŒã£ã¦ãŠã‚Šã€`Len()`ãƒ¡ã‚½ãƒƒãƒ‰ã§ç°¡å˜ã«å–å¾—ã§ãã¾ã™ã€‚

ã“ã®å ´åˆã¯ã€`http.NewRequest(WithContext)`å†…ã§`body.Len()`ã®å€¤ãŒ`ContentLength`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•çš„ã«ã‚»ãƒƒãƒˆã•ã‚Œã¾ã™([ã‚³ãƒ¼ãƒ‰](https://cs.opensource.google/go/go/+/refs/tags/go1.19.4:src/net/http/request.go;l=896))ã€‚

## `body`ã®é•·ã•ãŒã€Œè‡ªæ˜ã€ã§ã¯ãªã„å ´åˆ

ä¸Šè¨˜ä»¥å¤–ã®å ´åˆãŒè©²å½“ã—ã¾ã™ã€‚

ã“ã®å ´åˆã¯ã€`Transfer-Encoding: chunked`ã‚’åˆ©ç”¨ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’å°åˆ†ã‘ã«ã—ã¦é€ä¿¡ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã®æ–¹æ³•ã«ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£å…¨ä½“ã®é•·ã•(= `Content-Length`)ãŒäº‹å‰ã«åˆ†ã‹ã‚‰ãªãã¦ã‚‚ã‚ˆã„ã¨ã„ã†ç‰¹é•·ãŒã‚ã‚Šã¾ã™ã€‚


ã¾ã¨ã‚ã‚‹ã¨ã€é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®é•·ã•ãŒäº‹å‰ã«åˆ†ã‹ã£ã¦ã„ã‚‹ãªã‚‰ãã‚ŒãŒè‡ªå‹•çš„ã«è¨­å®šã•ã‚Œã‚‹ã—ã€é•·ã•ãŒäº‹å‰ã«åˆ†ã‹ã‚‰ãªã‘ã‚Œã°ã€Œé•·ã•ã®æƒ…å ±ã‚’äº‹å‰ã«é€ä¿¡ã—ãªãã¦ã‚‚ã„ã„æ–¹æ³•ã€ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€ã¨ã„ã†ã“ã¨ã§ã™ã€‚

# è‡ªåˆ†ã§ã‚»ãƒƒãƒˆã—ãªã„ã¨ã„ã‘ãªã„å ´åˆ

ä»¥ä¸Šã‚’è¸ã¾ãˆã‚‹ã¨ã€`Content-Length`ãƒ˜ãƒƒãƒ€ã‚’è‡ªåˆ†ã§ã‚»ãƒƒãƒˆã—ãªã‘ã‚Œã°ãªã‚‰ãªã„çŠ¶æ³ã¨ã„ã†ã®ã¯ã€**`body`ã®é•·ã•ãŒè‡ªæ˜ã§ãªãã€ã‹ã¤äº‹å‰(ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’é€ã‚Šå§‹ã‚ã‚‹å‰)ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£å…¨ä½“ã®é•·ã•ã‚’ã‚µãƒ¼ãƒã«é€ä¿¡ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„å ´åˆ**ã«é™ã‚‰ã‚Œã¾ã™ã€‚

å¾ŒåŠã®æ¡ä»¶ã«å½“ã¦ã¯ã¾ã‚‹å ´åˆã€ã‚µãƒ¼ãƒã¯[`411 Length Required`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/411)ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ã«ãªã£ã¦ã„ã¾ã™ã€‚ç­†è€…ã¯S3ã®presigned URLã‚’ä½¿ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã‚ˆã†ã¨ã—ãŸéš›ã«ã“ã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«é­é‡ã—ã¾ã—ãŸã€‚

# `Header`ã®ç½ 

`411`ã‚¨ãƒ©ãƒ¼ã¨ã„ã†ã®ã¯ã‚ã£ãŸã«ãŠç›®ã«ã‹ã‹ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€`Length Required`ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã€Œ`Content-Length`ãƒ˜ãƒƒãƒ€ã‚’ã‚»ãƒƒãƒˆã—ã¦ã‚ã’ã‚Œã°ã‚ˆã•ãã†ã ã€ã¨æ¨æ¸¬ã§ãã¾ã™ã€‚ã—ã‹ã—ã€ã“ã“ã§ç„¦ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã—ã¾ã†ã¨ã€å•é¡Œã¯æ€ã£ãŸã‚ˆã†ã«è§£æ±ºã—ã¦ãã‚Œã¾ã›ã‚“ã€‚

```go
var size int64 = ...
req.Header.Set("Content-Length", strconv.FormatInt(size, 10))
resp, err := httpCli.do(req)
```

ãªãœãªã‚‰ã€**`http.Request`ã®`Header`ã«ç›´æ¥ã‚»ãƒƒãƒˆã•ã‚ŒãŸ`Content-Length`ãƒ˜ãƒƒãƒ€ã®å†…å®¹ã¯ç„¡è¦–ã•ã‚Œã¦ã—ã¾ã†**ã‹ã‚‰ã§ã™ã€‚ã“ã®å ´åˆã¯å½“è©²ãƒ˜ãƒƒãƒ€ã‚’ã‚»ãƒƒãƒˆã—ãªã‹ã£ãŸã¨ãã¨åŒã˜æŒ™å‹•ã¨ãªã‚‹ãŸã‚ã€ã€Œ`Content-Length`ã‚’ã‚»ãƒƒãƒˆã—ãŸã¯ãšãªã®ã«`Length Required`ã¨æ€’ã‚‰ã‚Œã‚‹ã€ã¨ã„ã†ä¸€è¦‹ä¸å¯è§£ãªçŠ¶æ³ã«é™¥ã‚Šã¾ã™ã€‚

ç„¦ã‚‰ãšã€è½ã¡ç€ã„ã¦ã€**`http.Request`ã®`ContentLength`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã§`Content-Length`ãƒ˜ãƒƒãƒ€ãŒæ„å›³é€šã‚Šã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚

```go
var size int64 = ...
req.ContentLength = size
resp, err := httpCli.do(req)
```

åˆ†ã‹ã£ã¦ã—ã¾ãˆã°ã€Œãªã‚“ã ãã‚“ãªã“ã¨ã‹ã€ã¨ã„ã†æ„Ÿã˜ã§ã™ãŒã€ã‚ã£ãŸã«è¦‹ãªã„ã‚¨ãƒ©ãƒ¼ã®è§£æ±ºã®éµãŒæ™®æ®µã‚ã¾ã‚Šæ„è­˜ã—ã¦ã„ãªã„ã¨ã“ã‚ã«ã‚ã‚‹ã¨ãªã‚‹ã¨ã€æ„å¤–ã¨æ°—ã¥ã‘ãªã„ã‚‚ã®ã§ã™ã€‚

# ã¡ã‚‡ã£ã¨æ·±æ˜ã‚Š
## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€
ã“ã®`Content-Length`ãƒ˜ãƒƒãƒ€ã¾ã‚ã‚Šã®æŒ™å‹•ã«ã¤ã„ã¦ã¯ã€`http`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã«æ–­ç‰‡çš„ã«è¨˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

- [`http.Request.Header`](https://pkg.go.dev/net/http#Request)ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚ŠæŠœç²‹:

> For client requests, certain headers such as Content-Length and Connection are automatically written when needed and values in Header may be ignored. See the documentation for the Request.Write method.

> (æŠ„è¨³)
> ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãŠã„ã¦ã€Content-Lengthã‚„Connectionã¨ã„ã£ãŸãƒ˜ãƒƒãƒ€ã¯å¿…è¦ã«å¿œã˜ã¦è‡ªå‹•çš„ã«æ›¸ãè¾¼ã¾ã‚Œã€Headerã«è¨­å®šã—ãŸå€¤ãŒç„¡è¦–ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚Request.Writeãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã®ã“ã¨ã€‚


- [`http.Request.Write`](https://pkg.go.dev/net/http#Request.Write)ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚ŠæŠœç²‹:

> This method consults the following fields of the request:
>
> ```
> Host
> URL
> Method (defaults to "GET")
> Header
> ContentLength
> TransferEncoding
> Body
> ```

> (æŠ„è¨³)
> ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã†ã¡ä»¥ä¸‹ã®ã‚‚ã®ã‚’è€ƒæ…®ã™ã‚‹:
>
> (ç•¥)

## ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€
ã•ã‚‰ã«ã€`http`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é–¢é€£ã‚³ãƒ¼ãƒ‰ã‚’è¿½ã†ã“ã¨ã§ã€å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹`Content-Length`ãƒ˜ãƒƒãƒ€ã¯åŸºæœ¬çš„ã«`http.Request.ContentLength`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã®ã¿ã«åŸºã¥ã„ã¦æ±ºã¾ã‚Šã€`Header`ã«ç›´æ¥ã‚»ãƒƒãƒˆã•ã‚ŒãŸå€¤ã¯å®Œå…¨ã«ç„¡è¦–ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

:::details Content-Lengthãƒ˜ãƒƒãƒ€ã‚’æ›¸ãè¾¼ã‚€å‡¦ç†ã®æ¦‚è¦
è©²å½“ç®‡æ‰€: `http.Request.write`ãƒ¡ã‚½ãƒƒãƒ‰(`Write`ã®å†…éƒ¨å‡¦ç†ã€[ã‚³ãƒ¼ãƒ‰](https://cs.opensource.google/go/go/+/refs/tags/go1.19.4:src/net/http/request.go;l=551))

1. `newTransferWriter()`ã§ã€`transferWriter`ã‚’ç”Ÿæˆ([ã‚³ãƒ¼ãƒ‰](https://cs.opensource.google/go/go/+/refs/tags/go1.19.4:src/net/http/request.go;l=645))ã€‚ã“ã‚Œã¯`Request`ã®å†…å®¹ã‚’HTTPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«å‰‡ã£ã¦æ›¸ãè¾¼ã‚€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤ã€‚
    - ã“ã“ã§ã€`Content-Length`ãƒ˜ãƒƒãƒ€ã®å€¤ã«å¯¾å¿œã™ã‚‹`transferWriter.ContentLength`ã®å€¤ã¯`Request.ContentLength`ã®ã¿ã‚’è€ƒæ…®ã—ã¦è¨­å®šã•ã‚Œã‚‹([ã‚³ãƒ¼ãƒ‰](https://cs.opensource.google/go/go/+/refs/tags/go1.19.4:src/net/http/transfer.go;l=93))
2. `transferWriter.writeHeader`ãƒ¡ã‚½ãƒƒãƒ‰ã§`Content-Length`ãƒ˜ãƒƒãƒ€ã‚’å®Ÿéš›ã«æ›¸ãè¾¼ã‚€([ã‚³ãƒ¼ãƒ‰](https://cs.opensource.google/go/go/+/refs/tags/go1.19.4:src/net/http/transfer.go;l=290))
3. `Header.writeSubset`ãƒ¡ã‚½ãƒƒãƒ‰ã§`transferWriter`ãŒé–¢çŸ¥ã—ãªã„ãƒ˜ãƒƒãƒ€ã‚’æ›¸ãè¾¼ã‚€([ã‚³ãƒ¼ãƒ‰](https://cs.opensource.google/go/go/+/refs/tags/go1.19.4:src/net/http/request.go;l=654))ãŒã€ã“ã®ã¨ã`Header`ã«ã‚»ãƒƒãƒˆã•ã‚ŒãŸ`Content-Length`ã¯ç„¡è¦–ã•ã‚Œã‚‹(`reqWriteExcludeHeader`([ã‚³ãƒ¼ãƒ‰](https://cs.opensource.google/go/go/+/refs/tags/go1.19.4:src/net/http/request.go;l=89))ã«å«ã¾ã‚Œã‚‹ãŸã‚)
:::

## å®Ÿé¨“ã—ã¦ã¿ã‚‹
æ§˜ã€…ãªè¨­å®šã®ã‚‚ã¨ã§HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦å†…å®¹ã‚’è¦³å¯Ÿãƒ»æ¯”è¼ƒã™ã‚‹ã“ã¨ã§ã€HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆé–¢é€£ã®æŒ™å‹•ã«å¯¾ã™ã‚‹ç†è§£ã‚’æ·±ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚å®Ÿé¨“ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’GitHubã«ç½®ã„ã¦ãŠã„ãŸã®ã§ã€èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯ãœã²å‹•ã‹ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

https://github.com/jiftechnify/go-httpcli-req-observation

# ãŠã‚ã‚Šã«
Goã§HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†éš›ã«`Content-Length`ãƒ˜ãƒƒãƒ€ã‚’æ­£ã—ãè¨­å®šã™ã‚‹æ–¹æ³•ã€ã‚ã‚‹ã„ã¯`http.Request.Header`ã«ã‚»ãƒƒãƒˆã—ãŸ`Content-Length`ãŒç„¡è¦–ã•ã‚Œã‚‹ã¨ã„ã†ç½ ã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã—ãŸã€‚

èª­è€…ã®æ–¹ã€…ãŒåŒæ§˜ã®å•é¡Œã«é­é‡ã—ãŸéš›ã«ã€å†·é™ã«å¯¾å‡¦ã™ã‚‹åŠ©ã‘ã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

# å‚è€ƒæ–‡çŒ®
- [Sending Content-Length in Go](https://medium.com/ne-digital/sending-content-length-in-go-12a1fcf41251)

:::message
ã“ã®è¨˜äº‹ã¯ [Go Advent Calendar 2022](https://qiita.com/advent-calendar/2022/go) ã®11æ—¥ç›®ã®è¨˜äº‹(ä»£ç­†)ã§ã™ã€‚
:::
